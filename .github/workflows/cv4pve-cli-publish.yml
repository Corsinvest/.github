name: CV4PVE CLI Publish

on:
  workflow_call:
    inputs:
      project-name:
        description: "Executable name (without extension)"
        required: true
        type: string
      project-path:
        description: "Path to main project (.csproj)"
        required: true
        type: string
      nuget-project-path:
        description: "Path to API project for NuGet publishing (optional)"
        required: false
        type: string
      winget-id:
        description: "WinGet package identifier (optional)"
        required: false
        type: string
      dotnet-version:
        description: ".NET SDK version"
        required: false
        default: "10.0.x"
        type: string

env:
  DOTNET_VERSION: ${{ inputs.dotnet-version }}

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Extract and validate version
        id: version
        run: |
          PROJECT_VERSION=$(grep -oP '<Version>\K[^<]+' Directory.Build.props)
          echo "Project version: $PROJECT_VERSION"

          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "Tag version: $TAG_VERSION"

         if [ "$PROJECT_VERSION" != "$TAG_VERSION" ]; then
          echo "❌ ERROR: Version mismatch!"
          echo "   Directory.Build.props: $PROJECT_VERSION"
          echo "   Git tag: v$TAG_VERSION"
          exit 1
        fi

          echo "✅ Version validated: $PROJECT_VERSION"
          echo "version=$PROJECT_VERSION" >> $GITHUB_OUTPUT

      - name: Build and archive for each platform
        run: |
          mkdir -p ./publish

          declare -a platforms=(
            "win-x64|${{ inputs.project-name }}.exe-win-x64.zip|7z a -tzip"
            "win-x86|${{ inputs.project-name }}.exe-win-x86.zip|7z a -tzip"
            "win-arm64|${{ inputs.project-name }}.exe-win-arm64.zip|7z a -tzip"
            "linux-x64|${{ inputs.project-name }}-linux-x64.zip|zip -r"
            "linux-arm|${{ inputs.project-name }}-linux-arm.zip|zip -r"
            "linux-arm64|${{ inputs.project-name }}-linux-arm64.zip|zip -r"
            "osx-x64|${{ inputs.project-name }}-osx-x64.zip|zip -r"
            "osx-arm64|${{ inputs.project-name }}-osx-arm64.zip|zip -r"
          )

          for platform in "${platforms[@]}"; do
            IFS='|' read -r rid filename archive_cmd <<< "$platform"

            echo "Building for $rid..."
            dotnet publish ${{ inputs.project-path }} \
              -r $rid \
              -c Release \
              --self-contained true \
              -p:PublishSingleFile=true \
              -p:DebugType=embedded \
              -p:DebugSymbols=true \
              -o ./publish/$rid

            echo "Archiving $filename..."
            cd ./publish/$rid
            if [[ "$rid" == win-* ]]; then
              exe_name="${{ inputs.project-name }}.exe"
            else
              exe_name="${{ inputs.project-name }}"
            fi
            $archive_cmd "../../$filename" "$exe_name"
            cd ../..
          done

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          name: Release v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            ./${{ inputs.project-name }}*.zip

      - name: Build library for NuGet
        if: ${{ inputs.nuget-project-path != '' }}
        run: dotnet build ${{ inputs.nuget-project-path }} -c Release

      - name: Pack NuGet
        if: ${{ inputs.nuget-project-path != '' }}
        run: dotnet pack ${{ inputs.nuget-project-path }} -c Release --no-build --output ./nuget-packages

      - name: Publish NuGet
        if: ${{ inputs.nuget-project-path != '' }}
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          for package in ./nuget-packages/*.nupkg; do
            dotnet nuget push $package \
              --api-key $NUGET_API_KEY \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

  winget:
    needs: publish
    if: ${{ inputs.winget-id != '' }}
    runs-on: windows-latest
    steps:
      - name: Publish to WinGet
        uses: vedantmgoyal9/winget-releaser@v2
        with:
          identifier: ${{ inputs.winget-id }}
          installers-regex: '${{ inputs.project-name }}\.exe-win-(x64|x86|arm64)\.zip$'
          token: ${{ secrets.WINGET_TOKEN }}
          fork-user: ${{ github.repository_owner }}
        continue-on-error: true
